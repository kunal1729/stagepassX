<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Bookings | StagePassX</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>

<body>
  <div class="bg-[#FFFFFF] h-screen flex">
    <!-- Sidebar -->
    <div class="flex flex-col shadow-lg w-[20%] h-full border-r gap-12 p-12">
      <h1 class="text-black text-4xl font-bold">StagePassX</h1>
      <nav class="flex flex-col gap-8">
        <div class="flex gap-4 items-center">
          <img src="dashboard.png" alt="dashboard" class="w-8 h-8 rounded-full">
          <a href="bookings.html" class="text-[#414A4C] text-lg font-semibold">Dashboard</a>
        </div>
        <div class="flex gap-4 items-center">
          <img src="events.png" alt="events" class="w-8 h-8 rounded-full">
          <a href="events.html" class="text-[#414A4C] text-lg font-semibold">My Bookings</a>
        </div>
        <div class="flex gap-4 items-center">
          <img src="profile.png" alt="profile" class="w-8 h-8 rounded-full">
          <a href="profile.html" class="text-[#414A4C] text-lg font-semibold">Profile</a>
        </div>
      </nav>

      <!-- Logout Button -->
      <button 
        onclick="handleLogout()" 
        class="bg-red-500 text-white font-semibold px-5 py-2 rounded-lg hover:bg-red-600 transition">
        Logout
      </button>
    </div>

    <!-- Main Content -->
    <div class="w-[80%] h-full overflow-y-auto">
      <div class="flex w-full items-center justify-between border-b px-12 py-6">
        <h1 class="text-black text-2xl font-bold">My Bookings</h1>
      </div>

      <div class="flex flex-col gap-4 p-12">
        <h1 class="text-black text-xl font-bold">Upcoming Bookings</h1>

        <table class="w-full border-collapse shadow-sm rounded-xl overflow-hidden">
          <thead class="bg-blue-100 text-gray-700">
            <tr>
              <th class="text-left p-4">Event Name</th>
              <th class="text-left p-4">Date</th>
              <th class="text-left p-4">Venue</th>
              <th class="text-left p-4">Reference No.</th>
              <th class="text-left p-4">Quantity</th>
              <th class="text-left p-4">Status</th>
            </tr>
          </thead>
          <tbody id="bookingsTableBody">
            <tr>
              <td colspan="6" class="text-center text-gray-500 p-4">Loading bookings...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const API_URL_BOOKINGS = "http://localhost:9090/api/bookings/user";

    document.addEventListener("DOMContentLoaded", () => {
      // Highlight active sidebar link
      const currentPage = window.location.pathname.split("/").pop();
      const links = document.querySelectorAll(".nav-link");
      links.forEach(link => {
        if (link.getAttribute("href") === currentPage) {
          link.classList.add("text-blue-600", "font-bold");
        } else {
          link.classList.remove("text-blue-600", "font-bold");
        }
      });

      // Fetch user bookings
      fetchBookings();

      // Logout functionality
      document.getElementById("logoutBtn").addEventListener("click", handleLogout);
    });

    async function fetchBookings() {
      const tableBody = document.getElementById("bookingsTableBody");
      tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-gray-500 p-4">Loading bookings...</td></tr>`;

      try {
        const user = JSON.parse(localStorage.getItem("data"));
        if (!user?.userId) {
          tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-red-500 p-4">User not logged in</td></tr>`;
          return;
        }

        const response = await axios.post(`${API_URL_BOOKINGS}`, { userId: user.userId });
        console.log(response.data);
        const bookings = response.data;

        if (!bookings || bookings.length === 0) {
          tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-gray-500 p-4">No bookings yet.</td></tr>`;
          return;
        }

        tableBody.innerHTML = bookings.map(b => `
          <tr class="border-b hover:bg-blue-50 transition">
            <td class="p-4 font-semibold">${b?.eventName || "—"}</td>
            <td class="p-4">${b?.bookingDate ? new Date(b.bookingDate).toLocaleDateString() : "—"}</td>
            <td class="p-4">${b?.venueName || "—"}</td>
            <td class="p-4 font-semibold">#${b.bookingReference || "—"}</td>
            <td class="p-4">${b.quantity || 0}</td>
            <td class="p-4">
              <span class="px-3 py-1 rounded-full text-sm font-semibold 
                ${b.bookingStatus === "CONFIRMED" ? "bg-green-100 text-green-700" : 
                  b.bookingStatus === "PENDING" ? "bg-yellow-100 text-yellow-700" : 
                  "bg-red-100 text-red-700"}">
                ${b.bookingStatus || "—"}
              </span>
            </td>
          </tr>
        `).join('');
      } catch (error) {
        console.error("Error fetching bookings:", error);
        document.getElementById("bookingsTableBody").innerHTML =
          `<tr><td colspan="6" class="text-center text-red-500 p-4">Failed to load bookings.</td></tr>`;
      }
    }

    function handleLogout() {
      Swal.fire({
        title: "Are you sure you want to log out?",
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "Yes, logout",
        cancelButtonText: "Cancel",
        confirmButtonColor: "#ef4444",
      }).then(result => {
        if (result.isConfirmed) {
          localStorage.clear();
          Swal.fire({
            icon: "success",
            title: "Logged out successfully",
            showConfirmButton: false,
            timer: 1500,
          }).then(() => {
            window.location.href = "login.html"; // redirect page
          });
        }
      });
    }
  </script>
</body>
</html>
