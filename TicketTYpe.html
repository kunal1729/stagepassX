<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ticket Type | StagePassX</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- Axios -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  
  <style>
    /* Fix modal width and prevent overflow */
    .swal2-popup {
      width: 500px !important;
      max-width: 90vw !important;
      padding: 2rem !important;
    }
    
    .swal2-html-container {
      overflow-x: hidden !important;
      max-width: 100% !important;
    }
    
    .swal2-input, .swal2-textarea {
      width: 100% !important;
      box-sizing: border-box !important;
      margin: 0 !important;
    }
  </style>
</head>
<body>
  <div class="bg-[#FFFFFF] h-screen flex">
    <!-- Sidebar -->
    <div class="flex flex-col shadow-lg md:w-[20%] w-full h-auto md:h-screen border-r gap-6 md:gap-12 p-6 md:p-12">
      <h1 class="text-black text-2xl md:text-4xl font-bold">StagePassX</h1>

      <nav class="flex flex-col gap-8" id="sidebarNav">
        <div class="flex gap-4 items-center">
          <svg class="w-8 h-8 text-[#414A4C]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
          </svg>
          <a href="yourEvents.html" class="nav-link text-[#414A4C] text-lg font-semibold hover:text-blue-500">Dashboard</a>
        </div>

        <div class="flex gap-4 items-center">
          <svg class="w-8 h-8 text-[#414A4C]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
          </svg>
          <a href="venuepage.html" class="nav-link text-[#414A4C] text-lg font-semibold hover:text-blue-500">Venues</a>
        </div> 

        <div class="flex gap-4 items-center">
          <svg class="w-8 h-8 text-[#414A4C]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
          </svg>
          <a href="TicketTYpe.html" class="nav-link text-[#414A4C] text-lg font-semibold hover:text-blue-500">Ticket Types</a>  
        </div> 
      </nav>

      <!-- Logout Button -->
      <button 
        onclick="handleLogout()" 
        class="bg-red-500 text-white font-semibold px-5 py-2 rounded-lg hover:bg-red-600 transition">
        Logout
      </button>
    </div>


    <!-- Main Section -->
    <div class="w-[80%] h-full overflow-y-auto bg-gray-50">
      <!-- Content Container -->
      <div class="bg-white m-8 rounded-lg shadow-sm">
        <!-- Header -->
        <div class="flex items-center justify-between px-8 py-6 border-b">
          <div class="flex items-center gap-4">
            <h1 class="text-black text-3xl font-bold">Ticket Type</h1>
            <select id="eventFilter" onchange="filterByEvent()" class="px-4 py-2 border rounded-lg text-[#414A4C] focus:outline-none focus:ring-2 focus:ring-blue-300">
              <option value="">Select Event</option>
            </select>
          </div>
          <button 
            onclick="openCreateTicketTypeForm()" 
            class="bg-blue-500 font-semibold text-white px-5 py-2.5 rounded-lg hover:bg-blue-600 flex items-center gap-2 transition-colors">
            <span class="text-lg">+</span>
            Create Ticket Type
          </button>
        </div>

        <!-- Table -->
        <div class="p-8">
          <table class="w-full border-collapse">
            <thead class="bg-blue-100">
              <tr>
                <th class="text-left p-4 text-[#414A4C] font-semibold">Ticket Type</th>
                <th class="text-left p-4 text-[#414A4C] font-semibold">Price</th>
                <th class="text-left p-4 text-[#414A4C] font-semibold">Available</th>
                <th class="text-left p-4 text-[#414A4C] font-semibold">Sold</th>
                <th class="text-left p-4 text-[#414A4C] font-semibold">Status</th>
                <th class="text-left p-4 text-[#414A4C] font-semibold">Action</th>
              </tr>
            </thead>
            <tbody id="ticketTableBody">
              <tr>
                <td colspan="6" class="text-center text-gray-500 p-8">Select an event to view ticket types</td>
              </tr>
            </tbody>
          </table>

          <!-- Pagination -->
          <div class="flex items-center gap-2 mt-8" id="paginationContainer">
            <button onclick="changePage('prev')" class="w-8 h-8 flex items-center justify-center text-[#414A4C] hover:bg-gray-100 rounded transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
              </svg>
            </button>
            <button onclick="changePage(1)" class="page-btn w-8 h-8 flex items-center justify-center text-[#414A4C] hover:bg-gray-100 rounded font-semibold transition-colors">1</button>
            <button onclick="changePage(2)" class="page-btn w-8 h-8 flex items-center justify-center text-[#414A4C] hover:bg-gray-100 rounded transition-colors">2</button>
            <button onclick="changePage(3)" class="page-btn w-8 h-8 flex items-center justify-center text-[#414A4C] hover:bg-gray-100 rounded transition-colors">3</button>
            <button onclick="changePage('next')" class="w-8 h-8 flex items-center justify-center text-[#414A4C] hover:bg-gray-100 rounded transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const BASE_URL = "http://localhost:9090/api/ticket-types";
    const EVENTS_URL = "http://localhost:9090/api/events";
    let currentPage = 1;
    let totalPages = 3;
    let allTickets = [];
    let allEvents = [];

    // Highlight active link dynamically
    document.addEventListener("DOMContentLoaded", () => {
      const currentPageFile = window.location.pathname.split("/").pop();
      const links = document.querySelectorAll(".nav-link");

      links.forEach(link => {
        if (link.getAttribute("href") === currentPageFile) {
          link.classList.add("text-blue-600", "font-bold");
        } else {
          link.classList.remove("text-blue-600", "font-bold");
        }
      });

      // Load events for dropdown
      loadEvents();
    });

    // Load events for dropdown
    async function loadEvents() {
      try {
        const response = await axios.get(`${EVENTS_URL}/userId/${JSON.parse(localStorage.getItem('data')).userId}`);
        allEvents = response.data;
        
        const eventFilter = document.getElementById('eventFilter');
        eventFilter.innerHTML = '<option value="">Select Event</option>';
        
        allEvents.forEach(event => {
          const option = document.createElement('option');
          option.value = event.eventId;
          option.textContent = event.eventName;
          eventFilter.appendChild(option);
        });
      } catch (error) {
        console.error('Error loading events:', error);
      }
    }

    // Filter tickets by event
    async function filterByEvent() {
      const eventId = document.getElementById('eventFilter').value;
      
      if (!eventId) {
        const tableBody = document.getElementById("ticketTableBody");
        tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-gray-500 p-8">Select an event to view ticket types</td></tr>`;
        return;
      }

      const tableBody = document.getElementById("ticketTableBody");
      tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-gray-500 p-8">Loading ticket types...</td></tr>`;

      try {
        const response = await axios.post(`${BASE_URL}/event`, { eventId: parseInt(eventId) }, {
          headers: {
            'Content-Type': 'application/json'
          }
        });
        allTickets = response.data;
        console.log(allTickets);

        if (!allTickets.length) {
          tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-gray-500 p-8">No ticket types available for this event.</td></tr>`;
          return;
        }

        renderTickets();
      } catch (error) {
        console.error('Error fetching tickets:', error);
        tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-red-500 p-8">Error loading ticket types</td></tr>`;
      }
    }

    // Render tickets in table
    function renderTickets() {
      const tableBody = document.getElementById("ticketTableBody");
      tableBody.innerHTML = "";

      allTickets.forEach(ticket => {
        const statusClass = ticket.isActive ? 'bg-teal-100 text-teal-700' : 'bg-gray-100 text-gray-700';
        const statusText = ticket.isActive ? 'Active' : 'Inactive';
        
        const row = `
          <tr class="border-b hover:bg-gray-50 transition-colors">
            <td class="p-4 text-[#414A4C]">${ticket.typeName}</td>
            <td class="p-4 text-[#414A4C]">$${parseFloat(ticket.price).toFixed(2)}</td>
            <td class="p-4 text-[#414A4C]">${ticket.quantityAvailable}</td>
            <td class="p-4 text-[#414A4C]">${ticket.quantitySold}</td>
            <td class="p-4">
              <span class="px-3 py-1 rounded-full text-sm font-medium ${statusClass}">
                ${statusText}
              </span>
            </td>
            <td class="p-4 flex gap-4">
              <button onclick="editTicket(${ticket.ticketTypeId})" class="text-blue-500 hover:text-blue-700 font-semibold transition-colors">Edit</button>
              <button onclick="deleteTicket(${ticket.ticketTypeId})" class="text-red-500 hover:text-red-700 font-semibold transition-colors">Delete</button>
            </td>
          </tr>
        `;
        tableBody.insertAdjacentHTML("beforeend", row);
      });
    }

    // Create new ticket type
    async function openCreateTicketTypeForm() {
      const { value: formValues } = await Swal.fire({
        title: 'Create Ticket Type',
        html: `
          <div style="text-align: left; width: 100%; max-width: 100%;">
            <div style="margin-bottom: 1rem;">
              <label style="display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem;">Event *</label>
              <select id="eventId" class="swal2-input" style="width: 100%; margin: 0;">
                <option value="">Select Event</option>
                ${allEvents.map(event => `<option value="${event.eventId}">${event.eventName}</option>`).join('')}
              </select>
            </div>
            <div style="margin-bottom: 1rem;">
              <label style="display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem;">Ticket Type Name *</label>
              <input id="typeName" class="swal2-input" placeholder="e.g., VIP, Economy" style="width: 100%; margin: 0;">
            </div>
            <div style="margin-bottom: 1rem;">
              <label style="display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem;">Price ($) *</label>
              <input id="price" type="number" step="0.01" class="swal2-input" placeholder="100.00" style="width: 100%; margin: 0;">
            </div>
            <div style="margin-bottom: 1rem;">
              <label style="display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem;">Quantity Available *</label>
              <input id="quantityAvailable" type="number" class="swal2-input" placeholder="100" style="width: 100%; margin: 0;">
            </div>
            <div style="margin-bottom: 1rem;">
              <label style="display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem;">Quantity Sold</label>
              <input id="quantitySold" type="number" class="swal2-input" value="0" style="width: 100%; margin: 0;">
            </div>
            <div style="margin-bottom: 0;">
              <label style="display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem;">Status *</label>
              <select id="isActive" class="swal2-input" style="width: 100%; margin: 0;">
                <option value="true">Active</option>
                <option value="false">Inactive</option>
              </select>
            </div>
          </div>
        `,
        confirmButtonText: 'Create Ticket Type',
        confirmButtonColor: '#3b82f6',
        focusConfirm: false,
        showCancelButton: true,
        width: '500px',
        padding: '2rem',
        preConfirm: () => {
          const eventId = document.getElementById('eventId').value;
          const typeName = document.getElementById('typeName').value.trim();
          const price = parseFloat(document.getElementById('price').value);
          const quantityAvailable = parseInt(document.getElementById('quantityAvailable').value);
          const quantitySold = parseInt(document.getElementById('quantitySold').value);
          const isActive = document.getElementById('isActive').value === 'true';

          if (!eventId || !typeName || !price || !quantityAvailable) {
            Swal.showValidationMessage('Please fill all required fields');
            return false;
          }

          return {
            event: { eventId: parseInt(eventId) },
            typeName,
            price,
            quantityAvailable,
            quantitySold,
            isActive
          };
        }
      });

      if (formValues) {
        try {
          Swal.fire({
            title: 'Creating ticket type...',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading(),
          });

          await axios.post(`${BASE_URL}/create-ticket`, formValues, {
            headers: {
              'Content-Type': 'application/json'
            }
          });

          Swal.fire({
            icon: 'success',
            title: 'Ticket Type Created!',
            text: `${formValues.typeName} has been created successfully.`,
            confirmButtonColor: '#3b82f6'
          });

          // Refresh if event is selected
          if (document.getElementById('eventFilter').value) {
            filterByEvent();
          }
        } catch (error) {
          Swal.fire({
            icon: 'error',
            title: 'Error!',
            text: error.response?.data?.message || 'Failed to create ticket type.',
            confirmButtonColor: '#3b82f6'
          });
        }
      }
    }

    // Edit ticket type
    async function editTicket(ticketId) {
      try {
        Swal.fire({
          title: 'Loading...',
          allowOutsideClick: false,
          didOpen: () => Swal.showLoading(),
        });

        const response = await axios.get(`${BASE_URL}/${ticketId}`);
        const ticket = response.data;

        // IMPORTANT: Get eventId from current filter selection
        const selectedEventId = document.getElementById('eventFilter').value;
        
        if (!selectedEventId) {
          Swal.fire({
            icon: 'error',
            title: 'Error!',
            text: 'Please select an event first before editing.',
            confirmButtonColor: '#3b82f6'
          });
          return;
        }

        const { value: formValues } = await Swal.fire({
          title: 'Edit Ticket Type',
          html: `
            <div style="text-align: left; width: 100%; max-width: 100%;">
              <div style="margin-bottom: 1rem;">
                <label style="display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem;">Ticket Type Name *</label>
                <input id="typeName" class="swal2-input" value="${ticket.typeName || ''}" style="width: 100%; margin: 0;">
              </div>
              <div style="margin-bottom: 1rem;">
                <label style="display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem;">Price ($) *</label>
                <input id="price" type="number" step="0.01" class="swal2-input" value="${ticket.price || 0}" style="width: 100%; margin: 0;">
              </div>
              <div style="margin-bottom: 1rem;">
                <label style="display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem;">Quantity Available *</label>
                <input id="quantityAvailable" type="number" class="swal2-input" value="${ticket.quantityAvailable || 0}" style="width: 100%; margin: 0;">
              </div>
              <div style="margin-bottom: 1rem;">
                <label style="display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem;">Quantity Sold</label>
                <input id="quantitySold" type="number" class="swal2-input" value="${ticket.quantitySold || 0}" style="width: 100%; margin: 0;">
              </div>
              <div style="margin-bottom: 0;">
                <label style="display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem;">Status *</label>
                <select id="isActive" class="swal2-input" style="width: 100%; margin: 0;">
                  <option value="true" ${ticket.isActive ? 'selected' : ''}>Active</option>
                  <option value="false" ${!ticket.isActive ? 'selected' : ''}>Inactive</option>
                </select>
              </div>
            </div>
          `,
          confirmButtonText: 'Update',
          confirmButtonColor: '#3b82f6',
          focusConfirm: false,
          showCancelButton: true,
          width: '500px',
          padding: '2rem',
          preConfirm: () => {
            const typeName = document.getElementById('typeName').value.trim();
            const price = parseFloat(document.getElementById('price').value);
            const quantityAvailable = parseInt(document.getElementById('quantityAvailable').value);
            const quantitySold = parseInt(document.getElementById('quantitySold').value);
            const isActive = document.getElementById('isActive').value === 'true';

            if (!typeName || !price || !quantityAvailable) {
              Swal.showValidationMessage('Please fill all required fields');
              return false;
            }

            return {
              event: { eventId: parseInt(selectedEventId) },
              typeName,
              price,
              quantityAvailable,
              quantitySold,
              isActive
            };
          }
        });

        if (formValues) {
          Swal.fire({
            title: 'Updating...',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading(),
          });

          await axios.put(`${BASE_URL}/${ticketId}`, formValues, {
            headers: {
              'Content-Type': 'application/json'
            }
          });

          Swal.fire({
            icon: 'success',
            title: 'Updated!',
            text: 'Ticket type has been updated successfully.',
            confirmButtonColor: '#3b82f6'
          });

          filterByEvent();
        }
      } catch (error) {
        console.error('Error editing ticket:', error);
        const errorMessage = error.response?.data?.message || 
                             error.response?.data || 
                             'Failed to update ticket type.';
        
        Swal.fire({
          icon: 'error',
          title: 'Error!',
          text: typeof errorMessage === 'string' ? errorMessage : 'Failed to update ticket type.',
          confirmButtonColor: '#3b82f6'
        });
      }
    }

    // Delete ticket type
    async function deleteTicket(ticketId) {
      const result = await Swal.fire({
        title: 'Are you sure?',
        text: "You won't be able to revert this!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Yes, delete it!'
      });

      if (result.isConfirmed) {
        try {
          Swal.fire({
            title: 'Deleting...',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading(),
          });

          await axios.delete(`${BASE_URL}/${ticketId}`);

          Swal.fire({
            icon: 'success',
            title: 'Deleted!',
            text: 'Ticket type has been deleted.',
            confirmButtonColor: '#3b82f6'
          });

          filterByEvent();
        } catch (error) {
          const errorMessage = error.response?.data?.message || 
                               error.response?.data || 
                               'Failed to delete ticket type.';
          
          Swal.fire({
            icon: 'error',
            title: 'Cannot Delete!',
            text: typeof errorMessage === 'string' ? errorMessage : 'This ticket type may have existing bookings.',
            confirmButtonColor: '#3b82f6'
          });
        }
      }
    }

    // Pagination
    function changePage(page) {
      if (page === 'prev' && currentPage > 1) {
        currentPage--;
      } else if (page === 'next' && currentPage < totalPages) {
        currentPage++;
      } else if (typeof page === 'number') {
        currentPage = page;
      }

      document.querySelectorAll('.page-btn').forEach((btn, index) => {
        if (index + 1 === currentPage) {
          btn.classList.add('bg-blue-500', 'text-white');
          btn.classList.remove('text-[#414A4C]');
        } else {
          btn.classList.remove('bg-blue-500', 'text-white');
          btn.classList.add('text-[#414A4C]');
        }
      });
    }

    changePage(1);
    
    // Logout functionality
   function handleLogout() {
      Swal.fire({
        title: "Are you sure?",
        text: "You will be logged out of your account.",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#ef4444",
        cancelButtonColor: "#6b7280",
        confirmButtonText: "Logout",
      }).then((result) => {
        if (result.isConfirmed) {
          localStorage.removeItem("data");
          Swal.fire({
            icon: "success",
            title: "Logged Out!",
            text: "You have been logged out successfully.",
            confirmButtonColor: "#3b82f6",
          }).then(() => {
            window.location.href = "login.html";
          });
        }
      });
    }

  </script>
</body>
</html>