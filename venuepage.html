

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Venue | StagePassX</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- Axios -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
  <div class="bg-[#FFFFFF] h-screen flex">
    <!-- Sidebar -->
    <div class="flex flex-col shadow-lg md:w-[20%] w-full h-auto md:h-screen border-r gap-6 md:gap-12 p-6 md:p-12">
      <h1 class="text-black text-2xl md:text-4xl font-bold">StagePassX</h1>

      <nav class="flex flex-col gap-8" id="sidebarNav">
        <div class="flex gap-4 items-center">
          <svg class="w-8 h-8 text-[#414A4C]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
          </svg>
          <a href="yourEvents.html" class="nav-link text-[#414A4C] text-lg font-semibold hover:text-blue-500">Dashboard</a>
        </div>

        <div class="flex gap-4 items-center">
          <svg class="w-8 h-8 text-[#414A4C]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
          </svg>
          <a href="venuepage.html" class="nav-link text-[#414A4C] text-lg font-semibold hover:text-blue-500">Venues</a>
        </div> 

        <div class="flex gap-4 items-center">
          <svg class="w-8 h-8 text-[#414A4C]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
          </svg>
          <a href="TicketTYpe.html" class="nav-link text-[#414A4C] text-lg font-semibold hover:text-blue-500">Ticket Types</a>  
        </div> 
      </nav>

      <!-- Logout Button -->
      <button 
        onclick="handleLogout()" 
        class="bg-red-500 text-white font-semibold px-5 py-2 rounded-lg hover:bg-red-600 transition">
        Logout
      </button>
    </div>

    <!-- Main Section -->
    <div class="w-[80%] h-full overflow-y-auto bg-gray-50">
      <!-- Content Container -->
      <div class="bg-white m-8 rounded-lg shadow-sm">
        <!-- Header -->
        <div class="flex items-center justify-between px-8 py-6 border-b">
          <h1 class="text-black text-3xl font-bold">Venue</h1>
          <button 
            onclick="openAddVenueForm()" 
            class="bg-blue-500 font-semibold text-white px-5 py-2.5 rounded-lg hover:bg-blue-600 flex items-center gap-2 transition-colors">
            <span class="text-lg">+</span>
            Add Venue
          </button>
        </div>

        <!-- Table -->
        <div class="p-8">
          <table class="w-full border-collapse">
            <thead class="bg-blue-100">
              <tr>
                <th class="text-left p-4 text-[#414A4C] font-semibold">Venue Name</th>
                <th class="text-left p-4 text-[#414A4C] font-semibold">Address</th>
                <th class="text-left p-4 text-[#414A4C] font-semibold">City</th>
                <th class="text-left p-4 text-[#414A4C] font-semibold">Capacity</th>
                <th class="text-left p-4 text-[#414A4C] font-semibold">Action</th>
              </tr>
            </thead>
            <tbody id="venueTableBody">
              <tr>
                <td colspan="5" class="text-center text-gray-500 p-8">Loading venues...</td>
              </tr>
            </tbody>
          </table>

          <!-- Pagination -->
          <div class="flex items-center gap-2 mt-8" id="paginationContainer">
            <button onclick="changePage('prev')" class="w-8 h-8 flex items-center justify-center text-[#414A4C] hover:bg-gray-100 rounded transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
              </svg>
            </button>
            <button onclick="changePage(1)" class="page-btn w-8 h-8 flex items-center justify-center text-[#414A4C] hover:bg-gray-100 rounded font-semibold transition-colors">1</button>
            <button onclick="changePage(2)" class="page-btn w-8 h-8 flex items-center justify-center text-[#414A4C] hover:bg-gray-100 rounded transition-colors">2</button>
            <button onclick="changePage(3)" class="page-btn w-8 h-8 flex items-center justify-center text-[#414A4C] hover:bg-gray-100 rounded transition-colors">3</button>
            <button onclick="changePage('next')" class="w-8 h-8 flex items-center justify-center text-[#414A4C] hover:bg-gray-100 rounded transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const BASE_URL = "http://localhost:9090/api/venues";
    let currentPage = 1;
    let totalPages = 3;
    let allVenues = [];

    // Highlight active link dynamically
    document.addEventListener("DOMContentLoaded", () => {
      const currentPageFile = window.location.pathname.split("/").pop();
      const links = document.querySelectorAll(".nav-link");

      links.forEach(link => {
        if (link.getAttribute("href") === currentPageFile) {
          link.classList.add("text-blue-600", "font-bold");
        } else {
          link.classList.remove("text-blue-600", "font-bold");
        }
      });

      fetchVenues();
    });

    // Fetch venues from backend
    async function fetchVenues() {
      const tableBody = document.getElementById("venueTableBody");
      tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-gray-500 p-8">Loading venues...</td></tr>`;

      try {
        const response = await axios.get(`${BASE_URL}/getVenues`);
        allVenues = response.data;

        if (!allVenues.length) {
          tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-gray-500 p-8">No venues available.</td></tr>`;
          return;
        }

        renderVenues();
      } catch (error) {
        console.error('Error fetching venues:', error);
        tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-red-500 p-8">Error loading venues</td></tr>`;
      }
    }

    // Render venues in table - Handle both address and venueAddress
    function renderVenues() {
      const tableBody = document.getElementById("venueTableBody");
      tableBody.innerHTML = "";

      allVenues.forEach(venue => {
        const address = venue.venueAddress || venue.address || 'N/A';
        const row = `
          <tr class="border-b hover:bg-gray-50 transition-colors">
            <td class="p-4 text-[#414A4C]">${venue.venueName || 'N/A'}</td>
            <td class="p-4 text-[#414A4C]">${address}</td>
            <td class="p-4 text-[#414A4C]">${venue.city || 'N/A'}</td>
            <td class="p-4 text-[#414A4C]">${venue.totalCapacity || 0}</td>
            <td class="p-4 flex gap-4">
              <button onclick="editVenue(${venue.venueId})" class="text-blue-500 hover:text-blue-700 font-semibold transition-colors">Edit</button>
              <button onclick="deleteVenue(${venue.venueId})" class="text-red-500 hover:text-red-700 font-semibold transition-colors">Delete</button>
            </td>
          </tr>
        `;
        tableBody.insertAdjacentHTML("beforeend", row);
      });
    }

    // Add new venue - IMPORTANT: Uses "address" in request body
    async function openAddVenueForm() {
      const { value: formValues } = await Swal.fire({
        title: 'Add Venue',
        html: `
          <div style="text-align: left; width: 100%; max-width: 100%;">
            <div style="margin-bottom: 1rem;">
              <label style="display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem; color: #374151;">Venue Name *</label>
              <input id="venueName" class="swal2-input" placeholder="Grand Hall" style="width: 100%; margin: 0;">
            </div>
            <div style="margin-bottom: 1rem;">
              <label style="display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem; color: #374151;">Address *</label>
              <input id="venueAddress" class="swal2-input" placeholder="123 Main Street, Sector 21" style="width: 100%; margin: 0;">
            </div>
            <div style="margin-bottom: 1rem;">
              <label style="display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem; color: #374151;">City *</label>
              <input id="venueCity" class="swal2-input" placeholder="Mumbai" style="width: 100%; margin: 0;">
            </div>
            <div style="margin-bottom: 0;">
              <label style="display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem; color: #374151;">Total Capacity *</label>
              <input id="venueCapacity" type="number" class="swal2-input" placeholder="500" style="width: 100%; margin: 0;">
            </div>
          </div>
        `,
        confirmButtonText: 'Add Venue',
        confirmButtonColor: '#3b82f6',
        focusConfirm: false,
        showCancelButton: true,
        width: '500px',
        padding: '2rem',
        preConfirm: () => {
          const venueName = document.getElementById('venueName').value.trim();
          const address = document.getElementById('venueAddress').value.trim();
          const city = document.getElementById('venueCity').value.trim();
          const totalCapacity = parseInt(document.getElementById('venueCapacity').value);

          if (!venueName || !address || !city || !totalCapacity) {
            Swal.showValidationMessage('Please fill all required fields');
            return false;
          }
          // IMPORTANT: Send "address" not "venueAddress" per Postman
          return { venueName, address, city, totalCapacity };
        }
      });

      if (formValues) {
        try {
          Swal.fire({
            title: 'Adding venue...',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading(),
          });

          // IMPORTANT: POST to /createVenue (no /api/venues prefix)
          await axios.post(`http://localhost:9090/api/venues/createVenue`, formValues, {
            headers: {
              'Content-Type': 'application/json'
            }
          });

          Swal.fire({
            icon: 'success',
            title: 'Venue Added!',
            text: `${formValues.venueName} has been added successfully.`,
            confirmButtonColor: '#3b82f6'
          });

          fetchVenues();
        } catch (error) {
          console.error('Create venue error:', error);
          Swal.fire({
            icon: 'error',
            title: 'Error!',
            text: error.response?.data?.message || error.response?.data || 'Failed to add venue.',
            confirmButtonColor: '#3b82f6'
          });
        }
      }
    }

    // Edit venue - IMPORTANT: Uses "address" in request body
    async function editVenue(venueId) {
      try {
        Swal.fire({
          title: 'Loading...',
          allowOutsideClick: false,
          didOpen: () => Swal.showLoading(),
        });

        const response = await axios.get(`${BASE_URL}/${venueId}`);
        const venue = response.data;

        // Handle both address and venueAddress from response
        const currentAddress = venue.venueAddress || venue.address || '';

        const { value: formValues } = await Swal.fire({
          title: 'Edit Venue',
          html: `
            <div style="text-align: left; width: 100%; max-width: 100%;">
              <div style="margin-bottom: 1rem;">
                <label style="display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem; color: #374151;">Venue Name *</label>
                <input id="venueName" class="swal2-input" value="${venue.venueName || ''}" style="width: 100%; margin: 0;">
              </div>
              <div style="margin-bottom: 1rem;">
                <label style="display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem; color: #374151;">Address *</label>
                <input id="venueAddress" class="swal2-input" value="${currentAddress}" style="width: 100%; margin: 0;">
              </div>
              <div style="margin-bottom: 1rem;">
                <label style="display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem; color: #374151;">City *</label>
                <input id="venueCity" class="swal2-input" value="${venue.city || ''}" style="width: 100%; margin: 0;">
              </div>
              <div style="margin-bottom: 0;">
                <label style="display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem; color: #374151;">Total Capacity *</label>
                <input id="venueCapacity" type="number" class="swal2-input" value="${venue.totalCapacity || 0}" style="width: 100%; margin: 0;">
              </div>
            </div>
          `,
          confirmButtonText: 'Update',
          confirmButtonColor: '#3b82f6',
          focusConfirm: false,
          showCancelButton: true,
          width: '500px',
          padding: '2rem',
          preConfirm: () => {
            const venueName = document.getElementById('venueName').value.trim();
            const address = document.getElementById('venueAddress').value.trim();
            const city = document.getElementById('venueCity').value.trim();
            const totalCapacity = parseInt(document.getElementById('venueCapacity').value);

            if (!venueName || !address || !city || !totalCapacity) {
              Swal.showValidationMessage('Please fill all required fields');
              return false;
            }
            // IMPORTANT: Send "address" not "venueAddress" per Postman
            return { venueId, venueName, address, city, totalCapacity };
          }
        });

        if (formValues) {
          Swal.fire({
            title: 'Updating...',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading(),
          });

          await axios.put(`${BASE_URL}/${venueId}`, formValues, {
            headers: {
              'Content-Type': 'application/json'
            }
          });

          Swal.fire({
            icon: 'success',
            title: 'Updated!',
            text: 'Venue has been updated successfully.',
            confirmButtonColor: '#3b82f6'
          });

          fetchVenues();
        }
      } catch (error) {
        console.error('Update venue error:', error);
        Swal.fire({
          icon: 'error',
          title: 'Error!',
          text: error.response?.data?.message || error.response?.data || 'Failed to update venue.',
          confirmButtonColor: '#3b82f6'
        });
      }
    }

    // Delete venue
    async function deleteVenue(venueId) {
      const result = await Swal.fire({
        title: 'Are you sure?',
        text: "You won't be able to revert this!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Yes, delete it!',
        cancelButtonText: 'Cancel'
      });

      if (result.isConfirmed) {
        try {
          Swal.fire({
            title: 'Deleting...',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading(),
          });

          await axios.delete(`${BASE_URL}/${venueId}`);

          Swal.fire({
            icon: 'success',
            title: 'Deleted!',
            text: 'Venue has been deleted successfully.',
            confirmButtonColor: '#3b82f6'
          });

          fetchVenues();
        } catch (error) {
          console.error('Delete venue error:', error);
          Swal.fire({
            icon: 'error',
            title: 'Error!',
            text: error.response?.data?.message || error.response?.data || 'Failed to delete venue.',
            confirmButtonColor: '#3b82f6'
          });
        }
      }
    }

    // Pagination
    function changePage(page) {
      if (page === 'prev' && currentPage > 1) {
        currentPage--;
      } else if (page === 'next' && currentPage < totalPages) {
        currentPage++;
      } else if (typeof page === 'number') {
        currentPage = page;
      }

      document.querySelectorAll('.page-btn').forEach((btn, index) => {
        if (index + 1 === currentPage) {
          btn.classList.add('bg-blue-500', 'text-white');
          btn.classList.remove('text-[#414A4C]');
        } else {
          btn.classList.remove('bg-blue-500', 'text-white');
          btn.classList.add('text-[#414A4C]');
        }
      });
    }

    changePage(1);
    function handleLogout() {
      Swal.fire({
        title: "Are you sure?",
        text: "You will be logged out of your account.",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#ef4444",
        cancelButtonColor: "#6b7280",
        confirmButtonText: "Logout",
      }).then((result) => {
        if (result.isConfirmed) {
          localStorage.removeItem("data");
          Swal.fire({
            icon: "success",
            title: "Logged Out!",
            text: "You have been logged out successfully.",
            confirmButtonColor: "#3b82f6",
          }).then(() => {
            window.location.href = "login.html";
          });
        }
      });
    }
  </script>
</body>
</html>