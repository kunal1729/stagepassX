<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <title>Register Page</title>
    <style>
        .bg-pattern {
            background-image: 
                linear-gradient(rgba(40, 40, 43, 0.85), rgba(40, 40, 43, 0.85)),
                url('https://plus.unsplash.com/premium_photo-1666184130709-f3709060899a?w=500&auto=format&fit=crop&q=60&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTN8fHBhcnR5fGVufDB8fDB8fHww');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
    </style>
</head>
<body>
    <div class="p-12 bg-pattern min-h-screen">
        <nav class="flex justify-between">
            <a href="index.html" class="text-white text-2xl font-bold hover:text-gray-300 cursor-pointer">StagePassX</a>
        </nav>
        <div class="flex w-full gap-8 justify-center items-center flex flex-col pt-12">
            <h1 class="text-white text-4xl font-bold">REGISTER</h1>
            <p class="text-white text-lg">Please enter your details</p>
            <p class="text-white text-sm mt-2">Already have an account? <a href="login.html" class="text-blue-400 hover:text-blue-300 underline">Login here</a></p>
            
            <form id="registerForm" action="#" class="w-[70%]">
                <div class="flex flex-col gap-8">
                    <div class="flex flex-col gap-4">
                        <div>
                            <input id="username" type="text" placeholder="Username" class="bg-transparent focus:outline-none border border-white px-4 py-2 rounded-full text-white w-full">
                            <p id="usernameError" class="text-red-400 text-sm mt-2 ml-4 hidden"></p>
                        </div>
                        
                        <div class="flex gap-4 w-full justify-between flex-col sm:flex-row">
                            <div class="w-full sm:w-1/2">
                                <input id="firstName" type="text" placeholder="First Name" class="bg-transparent w-full focus:outline-none border border-white px-4 py-2 rounded-full text-white">
                                <p id="firstNameError" class="text-red-400 text-sm mt-2 ml-4 hidden"></p>
                            </div>
                            <div class="w-full sm:w-1/2">
                                <input id="lastName" type="text" placeholder="Last Name" class="bg-transparent w-full focus:outline-none border border-white px-4 py-2 rounded-full text-white">
                                <p id="lastNameError" class="text-red-400 text-sm mt-2 ml-4 hidden"></p>
                            </div>
                        </div>
                        
                        <div>
                            <input id="phoneNumber" type="text" placeholder="Phone Number" class="bg-transparent focus:outline-none border border-white px-4 py-2 rounded-full text-white w-full">
                            <p id="phoneNumberError" class="text-red-400 text-sm mt-2 ml-4 hidden"></p>
                        </div>
                        
                        <div>
                            <select id="role" class="bg-transparent focus:outline-none border border-white px-4 py-2 rounded-full text-white w-full">
                                <option value="" class="bg-[#28282B]">Select Role</option>
                                <option value="CUSTOMER" class="bg-[#28282B]">Customer</option>
                                <option value="ORGANIZER" class="bg-[#28282B]">Organizer</option>
                            </select>
                            <p id="roleError" class="text-red-400 text-sm mt-2 ml-4 hidden"></p>
                        </div>
                        
                        <div>
                            <input id="email" type="text" placeholder="Email" class="bg-transparent focus:outline-none border border-white px-4 py-2 rounded-full text-white w-full">
                            <p id="emailError" class="text-red-400 text-sm mt-2 ml-4 hidden"></p>
                        </div>
                        
                        <div>
                            <input id="passwordHash" type="password" placeholder="Password" class="bg-transparent focus:outline-none border border-white px-4 py-2 rounded-full text-white w-full">
                            <p id="passwordError" class="text-red-400 text-sm mt-2 ml-4 hidden"></p>
                        </div>
                    </div>
                    
                    <div id="generalError" class="text-red-400 text-center hidden"></div>
                    <div id="generalSuccess" class="text-green-400 text-center hidden"></div>
                    
                    <button type="submit" class="bg-white text-black px-4 py-2 rounded-full hover:bg-black hover:text-white transition-colors">Register</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        const form = document.getElementById("registerForm");

        // Validation functions
        function validateUsername(username) {
            const usernameRegex = /^[a-zA-Z0-9_]{3,20}$/;
            return usernameRegex.test(username);
        }

        function validateName(name) {
            const nameRegex = /^[a-zA-Z\s]{2,30}$/;
            return nameRegex.test(name);
        }

        function validateEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function validatePhoneNumber(phone) {
            const phoneRegex = /^[0-9]{10}$/;
            return phoneRegex.test(phone);
        }

        function validatePassword(password) {
            const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&#])[A-Za-z\d@$!%*?&#]{8,}$/;
            return passwordRegex.test(password);
        }

        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
        }

        function hideError(elementId) {
            const errorElement = document.getElementById(elementId);
            errorElement.classList.add('hidden');
        }

        function hideAllErrors() {
            hideError('usernameError');
            hideError('firstNameError');
            hideError('lastNameError');
            hideError('phoneNumberError');
            hideError('roleError');
            hideError('emailError');
            hideError('passwordError');
            hideError('generalError');
            hideError('generalSuccess');
        }

        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            hideAllErrors();

            const username = document.getElementById("username").value.trim();
            const firstName = document.getElementById("firstName").value.trim();
            const lastName = document.getElementById("lastName").value.trim();
            const phoneNumber = document.getElementById("phoneNumber").value.trim();
            const role = document.getElementById("role").value;
            const email = document.getElementById("email").value.trim();
            const passwordHash = document.getElementById("passwordHash").value.trim();

            let isValid = true;

            // Validate username
            if (!username) {
                showError('usernameError', 'Username is required');
                isValid = false;
            } else if (!validateUsername(username)) {
                showError('usernameError', 'Username must be 3-20 characters long and contain only letters, numbers, and underscores');
                isValid = false;
            }

            // Validate first name
            if (!firstName) {
                showError('firstNameError', 'First name is required');
                isValid = false;
            } else if (!validateName(firstName)) {
                showError('firstNameError', 'First name must be 2-30 characters and contain only letters');
                isValid = false;
            }

            // Validate last name
            if (!lastName) {
                showError('lastNameError', 'Last name is required');
                isValid = false;
            } else if (!validateName(lastName)) {
                showError('lastNameError', 'Last name must be 2-30 characters and contain only letters');
                isValid = false;
            }

            // Validate phone number
            if (!phoneNumber) {
                showError('phoneNumberError', 'Phone number is required');
                isValid = false;
            } else if (!validatePhoneNumber(phoneNumber)) {
                showError('phoneNumberError', 'Phone number must be exactly 10 digits');
                isValid = false;
            }

            // Validate role
            if (!role) {
                showError('roleError', 'Please select a role');
                isValid = false;
            }

            // Validate email
            if (!email) {
                showError('emailError', 'Email is required');
                isValid = false;
            } else if (!validateEmail(email)) {
                showError('emailError', 'Please enter a valid email address (e.g., user@example.com)');
                isValid = false;
            }

            // Validate password
            if (!passwordHash) {
                showError('passwordError', 'Password is required');
                isValid = false;
            } else if (!validatePassword(passwordHash)) {
                showError('passwordError', 'Password must be at least 8 characters with uppercase, lowercase, number, and special character (@$!%*?&#)');
                isValid = false;
            }

            if (!isValid) {
                return;
            }

            // If validation passes, proceed with API call
            const userData = {
                username: username,
                email: email,
                passwordHash: passwordHash,
                firstName: firstName,
                lastName: lastName,
                phoneNumber: phoneNumber,
                role: role
            };

            try {
                const response = await axios.post(
                    "http://localhost:9090/users/register",
                    userData
                );

                console.log("✅ Registration Success:", response.data);
                
                const successElement = document.getElementById('generalSuccess');
                successElement.textContent = "✅ Registration successful! Redirecting to login...";
                successElement.classList.remove('hidden');
                
                setTimeout(() => {
                    window.location.href = "login.html";
                }, 2000);

            } catch (error) {
                console.error("❌ Registration Error:", error);
                console.error("Error response:", error.response);
                
                if (error.response) {
                    // Server responded with error
                    if (error.response.data) {
                        if (typeof error.response.data === 'string') {
                            showError('generalError', error.response.data);
                        } else if (error.response.data.message) {
                            showError('generalError', error.response.data.message);
                        } else {
                            showError('generalError', `❌ Registration failed: ${JSON.stringify(error.response.data)}`);
                        }
                    } else {
                        showError('generalError', `❌ Registration failed with status ${error.response.status}`);
                    }
                } else if (error.request) {
                    // Request made but no response
                    showError('generalError', '❌ No response from server. Please check if the backend is running.');
                } else {
                    // Error in setting up request
                    showError('generalError', `❌ Error: ${error.message}`);
                }
            }
        });
    </script>
</body>
</html>